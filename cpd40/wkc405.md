# Deploying Watson Knowledge Catalog 4.0.5

## Topics

- [ ] Deployment Planning
- [ ] Setup Bastion Host
- [ ] Registry Mirroring
- [ ] Configuring cluster pull images
- [ ] Node settings
- [ ] Project creation and NamespaceScope
- [ ] Custom Security Context Constraints
- [ ] Create IBM Operator Catalog source
- [ ] Installing IBM Cloud Pak foundation services
- [ ] Installing Cloud Pak for Data platform
- [ ] Installing Watson Knowledge Catalog
- [ ] WKC post-installation tasks
- [ ] Installing license server
- [ ] 

***
#### 1.0  Deployment planning
***

#### Requirements

- Sizing the Cluster
  https://app.ibmsalesconfigurator.com
  
- OpenShift 4.6.30+ or 4.8.x

- Cluster Compute Requirement
  - [ ] Minimum 3 compute nodes
  - [ ] Each node should be of minimum 16core, 64GB RAM and 200GB storage
  - [ ] Total Compute requirement will be calculated based on the number of services and user workload. IBM Team will help size the cluster compute requirements. 
  - [ ] Minimum Compute requirement for installation: 48 Core, 196 GB
  - [ ] OpenShift nodes should meet the configuration requirements for CPD services

- Cloud Pak for Data 4.0.5 Services
  - [ ] Cloud Pak Foundational Service
  - [ ] Cloud Pak for Data - Control Plane
  - [ ] Watson Knowledge Catalog and its bundle

- Networking Internet access to Mirror IBM image registries
  - [ ] docker.io/ibmcom
  - [ ] quay.io/opencloudio
  - [ ] cp.icr.io/cp 
  - [ ] icr.io/cpopen
  - [ ] https://github.com
  
- Networking Internet access to download IBM installer and cases:
  - [ ] https://github.com/IBM/cloud-pak-cli/releases/download
  - [ ] https://github.com/IBM/cloud-pak/raw/master/repo/case
- Storage
  - [ ] Persistent Storage 1 TB
  - [ ] Private Registry Storage 500 GB (example, Artifactory)
- License
  - [ ] IBM Cloud Pak for Data Standard/Enterprise license
  - [ ] Access to IBM Entitlement Key (myibm.ibm.com)
- User Permissions
  - [ ] OpenShift Administrator ( Cluster preparation )
  - [ ] Cloud Pak for Data administrator ( WKC Installation )
  - [ ] Read/Write permission to Artifactory Registry 
- Bastion Host
   - [ ] RHEL 8x, 500GB disk
   - [ ] Skopeo 1.x
   - [ ] python 3.x
   - [ ] pyyaml, jq

***
#### 2.0 Setup Bastion Host
***


* [ ] Namespaces and Deployment configurations

```
export IBM_COMMON_SERVICE=cpd-common-services  # Project namespace for IBM Foundational services operators
# export CPD_OPERATORS=cpd-common-services     # Project namespace for Cloud Pak for Data Operators
export CPD_INSTANCE=cpd                        # Project namespace for Cloud Pak for Data Install
export STORAGE_TYPE=ocs                        # Specify the type of storage to use, such as ocs , nfs or portworx values nfs, ocs, portworx
export CPD_LICENSE=Enterprise                  # license: Enterprise|Standard  Specify the Cloud Pak for Data license you purchased
export STORAGE_CLASS=ocs-storagecluster-cephfs        # Replace with the name of a RWX storage class
export ZEN_METADB=ocs-storagecluster-ceph-rbd          # (Recommended) Replace with the name of a RWO storage class

# Entitlement and Access tokens
export REGISTRY_USER=cp 
export REGISTRY_PASSWORD=<entitlement-key>      # Cloud Pak for Data Entitlement key from myibm.com 
export REGISTRY_SERVER=cp.icr.io

export PRIVATE_REGISTRY=<registry url>          
export PRIVATE_REGISTRY_USER=<admin>
export PRIVATE_REGISTRY_PASSWORD=<adminpass>

export CASE_REPO_PATH=https://github.com/IBM/cloud-pak/raw/master/repo/case
export CASECTL_RESOLVE_DEPENDENCIES=false                         # This required for ibm-cp-datacore
export USE_SKOPEO=true

export HOMEDIR=/root/cpd405
export OFFLINEDIR=${HOMEDIR}/offline/cpd
export OFFLINEDIR_CPFS=${HOMEDIR}/offline/cpfs
export OFFLINEDIR_WA=${HOMEDIR}/offline/wa

mkdir -p  ${OFFLINEDIR}
mkdir -p  ${OFFLINEDIR_CPFS}
mkdir -p  ${OFFLINEDIR_WA}
cd ${HOMEDIR}

```

* [ ] Download Installer

Prerequisite

- OpenShift CLI	Required to interact with your Red Hat OpenShift Container Platform cluster.
- IBM Cloud Pak CLI (cloudctl)	Required to download images from the IBM Entitled Registry.
- httpd-tools	Required to run the IBM Cloud Pak CLI (cloudctl).
- skopeo Version 1.2.0 or later	Required to run the IBM Cloud Pak CLI (cloudctl).

```
# Skopeo 1.2.x version is required
sudo yum install -y httpd-tools podman ca-certificates openssl skopeo jq bind-utils git

# Python3 is required
yum install -y python3
alternatives --set python /usr/bin/python3
pip3 install pyyaml


# Cloud Pak Installer
wget https://github.com/IBM/cloud-pak-cli/releases/download/v3.12.1/cloudctl-linux-amd64.tar.gz

tar -xf cloudctl-linux-amd64.tar.gz
cp cloudctl-linux-amd64 /usr/bin/cloudctl
cloudctl version

# OpenShift client (if you don't have latest oc client)
wget https://mirror.openshift.com/pub/openshift-v4/clients/ocp/4.8.26/openshift-client-linux-4.8.26.tar.gz
tar xvf openshift-client-linux-4.8.26.tar.gz
cp oc /usr/bin
cp kubectl /usr/bin

oc version

```



***
#### 3.0 OpenShift cluster Setup
***

* [ ] OpenShift Version
```
OpenShift version 4.6.30+ or 4.8.x are supported versions


oc get clusterversion
NAME      VERSION   AVAILABLE   PROGRESSING   SINCE   STATUS
version   4.8.26    True        False         13d     Cluster version is 4.8.26


If the cluster is in olderversion
```


* [ ] [Setup Persistent Storage and Storage Classes](https://www.ibm.com/docs/en/cloud-paks/cp-data/4.0?topic=tasks-setting-up-shared-persistent-storage)


Red Hat OpenShift Container Storage, IBM SpectrumÂ® Scale Container Native, Portworx and NFS are supported storage types

```
# Sample output
oc get storageclass

NAME                            PROVISIONER                             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
localblock-sc                   kubernetes.io/no-provisioner            Delete          WaitForFirstConsumer   false                  25d
managed-nfs-storage (default)   nfs-provisioner/nfs                     Delete          Immediate              false                  25d
ocs-storagecluster-ceph-rbd     openshift-storage.rbd.csi.ceph.com      Delete          Immediate              true                   25d
ocs-storagecluster-ceph-rgw     openshift-storage.ceph.rook.io/bucket   Delete          Immediate              false                  25d
ocs-storagecluster-cephfs       openshift-storage.cephfs.csi.ceph.com   Delete          Immediate              true                   25d
openshift-storage.noobaa.io     openshift-storage.noobaa.io/obc         Delete          Immediate              false                  25d
```

***
#### 4.0 Project 
***

#### Create project namespaces for Cloud Pak for Data Installations
```
oc project cpd
oc project ibm-common-services
```
#### OperatorGroup

```
cat <<EOF |oc apply -f -
apiVersion: operators.coreos.com/v1alpha2
kind: OperatorGroup
metadata:
  name: operatorgroup
  namespace: ibm-common-services
spec:
  targetNamespaces:
  - ibm-common-services
EOF
```
#### IBM NamespaceScope Operator
To watch IBM Common Services and Cloud Pak for Data namespaces

```
cat <<EOF |oc apply -f -
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: ibm-namespace-scope-operator
  namespace: ${IBM_COMMON_SERVICE}
spec:
  channel: v3
  installPlanApproval: Automatic
  name: ibm-namespace-scope-operator
  source: opencloud-operators
  sourceNamespace: openshift-marketplace
EOF


Wait for the Namescope operator pod to come up before running the next command 
oc get pods -n ${IBM_COMMON_SERVICE}


cat <<EOF |oc apply -f -
apiVersion: operator.ibm.com/v1
kind: NamespaceScope
metadata:
  name: cpd-operators
  namespace: ${IBM_COMMON_SERVICE}
spec:
  namespaceMembers:
  - ${IBM_COMMON_SERVICE}
  - ${CPD_INSTANCE}
EOF
```

#### ConfigMap for Deploying in custom namespaces
```
IBM Common services are deployed in the namespace "ibm-common-services", Cloud Pak for Data operators are in "cpd-operators" by default. ConfigMap is required when customer wants to use custom namespaces.
```

```
cat <<EOF |oc apply -f -
apiVersion: v1
kind: ConfigMap
metadata:
  name: common-service-maps
  namespace: kube-public
data: 
  common-service-maps.yaml: |
    namespaceMapping:
    - requested-from-namespace:
      - ${CPD_INSTANCE}
      map-to-common-service-namespace: ${IBM_COMMON_SERVICE}     
    defaultCsNs: ibm-common-services
EOF
```



